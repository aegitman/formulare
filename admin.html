<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Coordinates Extractor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    canvas {
      border: 1px solid #000;
      max-width: 100%;
      height: auto;
    }
    dialog {
      width: 300px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    dialog input, dialog select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
    dialog button {
      padding: 8px 16px;
      margin-right: 10px;
    }
    #dashLengthInput {
      display: none; /* Hidden by default */
    }
    .form-container {
      margin-top: 20px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>PDF Coordinates Extractor</h1>
  <input type="file" id="pdfInput" accept="application/pdf">
  <button id="submitButton">Submit</button>
  <br><br>
  <canvas id="pdfCanvas"></canvas>

  <dialog id="coordDialog">
    <h3>Coordinates</h3>
    <p>X: <span id="coordX"></span>, Y: <span id="coordY"></span></p>
    <select id="contentType">
      <option value="text">Text</option>
      <option value="dash">Dash</option>
      <option value="x">X</option>
      <option value="number">Number</option>
      <option value="phone">Phone</option>
      <option value="email">Email</option>
      <option value="date">Date</option>
      <option value="select">Select</option>
    </select>
    <input type="text" id="placeholderName" placeholder="Enter placeholder name">
    <input type="text" id="labelInput" placeholder="Enter label for the input">
    <input type="number" id="dashLengthInput" placeholder="Enter dash length">
    <input type="number" id="col" placeholder="col (1-12)" min="1" max="12">
    <input type="number" id="colMD" placeholder="col-md (1-12)" min="1" max="12">
    <input type="number" id="colLG" placeholder="col-lg (1-12)" min="1" max="12">
    <br><br>
    <button id="saveDialog">Save</button>
    <button id="cancelDialog">Cancel</button>
  </dialog>

  <br><br>
  <button id="logButton">Log Coordinates</button>
  <button id="generateFormButton">Generate Form</button>
  <button id="downloadHtmlButton">Download HTML</button>

  <div id="formContainer" class="form-container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    let pdfDoc = null;
    let pageNum = 1;
    let scale = 1;
    let canvas = document.getElementById('pdfCanvas');
    let ctx = canvas.getContext('2d');
    let coordDialog = document.getElementById('coordDialog');
    let coordX = document.getElementById('coordX');
    let coordY = document.getElementById('coordY');
    let placeholderName = document.getElementById('placeholderName');
    let labelInput = document.getElementById('labelInput');
    let contentType = document.getElementById('contentType');
    let dashLengthInput = document.getElementById('dashLengthInput');
    let colInput = document.getElementById('col');
    let colMDInput = document.getElementById('colMD');
    let colLGInput = document.getElementById('colLG');
    let coordinatesList = [];

    // Load and render PDF
    document.getElementById('submitButton').addEventListener('click', () => {
      const file = document.getElementById('pdfInput').files[0];
      if (file && file.type === 'application/pdf') {
        const fileReader = new FileReader();
        fileReader.onload = function (e) {
          const pdfData = new Uint8Array(e.target.result);
          pdfjsLib.getDocument({ data: pdfData }).promise.then((pdf) => {
            pdfDoc = pdf;
            renderPage(pageNum);
          });
        };
        fileReader.readAsArrayBuffer(file);
      } else {
        alert('Please select a valid PDF file.');
      }
    });

    // Render a page
    function renderPage(num) {
      pdfDoc.getPage(num).then((page) => {
        const viewport = page.getViewport({ scale: window.innerWidth / page.getViewport({ scale: 1 }).width });
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        scale = viewport.scale;

        const renderContext = {
          canvasContext: ctx,
          viewport: viewport,
        };
        page.render(renderContext).promise.then(() => {
          console.log('Page rendered');
        });
      });
    }

    // Handle canvas click
    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // Convert canvas coordinates to PDF coordinates
      const pdfX = x / scale;
      const pdfY = (canvas.height - y) / scale;

      // Show coordinates in dialog
      coordX.textContent = pdfX.toFixed(2);
      coordY.textContent = pdfY.toFixed(2);
      coordDialog.showModal();
    });

    // Show/hide dash length input and disable label/name for dash type
    contentType.addEventListener('change', () => {
      if (contentType.value === 'dash') {
        dashLengthInput.style.display = 'block';
        placeholderName.disabled = true;
        labelInput.disabled = true;
      } else {
        dashLengthInput.style.display = 'none';
        placeholderName.disabled = false;
        labelInput.disabled = false;
      }
    });

    // Save dialog
    document.getElementById('saveDialog').addEventListener('click', () => {
      const name = placeholderName.value.trim();
      const label = labelInput.value.trim();
      const type = contentType.value;
      const dashLength = type === 'dash' ? parseFloat(dashLengthInput.value) : null;
      const col = parseInt(colInput.value);
      const colMD = parseInt(colMDInput.value);
      const colLG = parseInt(colLGInput.value);

      // Validate name uniqueness (except for dash type)
      if (type !== 'dash') {
        const isDuplicate = coordinatesList.some(item => item.name === name);
        if (isDuplicate) {
          alert('Placeholder name must be unique. Please choose a different name.');
          return; // Stop saving if duplicate
        }
      }

      if ((type === 'dash' || (name && label)) && col >= 1 && col <= 12 && colMD >= 1 && colMD <= 12 && colLG >= 1 && colLG <= 12) {
        coordinatesList.push({
          x: parseFloat(coordX.textContent),
          y: parseFloat(coordY.textContent),
          name: type === 'dash' ? null : name,
          label: type === 'dash' ? null : label,
          type: type,
          dashLength: dashLength,
          col: col,
          colMD: colMD,
          colLG: colLG,
        });
        placeholderName.value = '';
        labelInput.value = '';
        dashLengthInput.value = '';
        colInput.value = '';
        colMDInput.value = '';
        colLGInput.value = '';
        dashLengthInput.style.display = 'none'; // Reset dash length input visibility
        placeholderName.disabled = false;
        labelInput.disabled = false;
        coordDialog.close();
      } else {
        alert('Please fill all fields correctly.');
      }
    });

    // Cancel dialog
    document.getElementById('cancelDialog').addEventListener('click', () => {
      placeholderName.value = '';
      labelInput.value = '';
      dashLengthInput.value = '';
      colInput.value = '';
      colMDInput.value = '';
      colLGInput.value = '';
      dashLengthInput.style.display = 'none'; // Reset dash length input visibility
      placeholderName.disabled = false;
      labelInput.disabled = false;
      coordDialog.close();
    });

    // Log coordinates
    document.getElementById('logButton').addEventListener('click', () => {
      console.log('Coordinates List:', coordinatesList);
    });

    // Generate form
    document.getElementById('generateFormButton').addEventListener('click', () => {
      generateForm();
    });

    // Download HTML
    document.getElementById('downloadHtmlButton').addEventListener('click', () => {
      const formHtml = document.getElementById('formContainer').innerHTML;
      const blob = new Blob([formHtml], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'form.html';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Function to generate form
    function generateForm() {
      const formContainer = document.getElementById('formContainer');
      formContainer.innerHTML = ''; // Clear previous content

      let currentRow = document.createElement('div');
      currentRow.className = 'row';
      formContainer.appendChild(currentRow);

      let currentColSum = 0;

      coordinatesList.forEach((item) => {
        if (item.type === 'dash') {
          return; // Skip dash type
        }

        if (currentColSum + item.col > 12) {
          currentRow = document.createElement('div');
          currentRow.className = 'row';
          formContainer.appendChild(currentRow);
          currentColSum = 0;
        }

        const colDiv = document.createElement('div');
        colDiv.className = `col-${item.col} col-md-${item.colMD} col-lg-${item.colLG} mb-3`;

        if (item.type !== 'x') {
          const label = document.createElement('label');
          label.className = 'form-label';
          label.textContent = item.label;
          label.setAttribute('for', item.name); // Link label to input
          colDiv.appendChild(label);
        }

        let input;
        if (item.type === 'text') {
          input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          input.id = item.name; // Set id
          input.name = item.name; // Set name
        } else if (item.type === 'number') {
          input = document.createElement('input');
          input.type = 'number';
          input.className = 'form-control';
          input.id = item.name;
          input.name = item.name;
        } else if (item.type === 'phone') {
          input = document.createElement('input');
          input.type = 'tel';
          input.className = 'form-control';
          input.pattern = '^[+]?[(]?[0-9]{3}[)]?[-\\s.]?[0-9]{3}[-\\s.]?[0-9]{4,6}$';
          input.title = 'Please enter a valid phone number (e.g., +123-456-7890).';
          input.id = item.name;
          input.name = item.name;
        } else if (item.type === 'email') {
          input = document.createElement('input');
          input.type = 'email';
          input.className = 'form-control';
          input.id = item.name;
          input.name = item.name;
        } else if (item.type === 'date') {
          input = document.createElement('input');
          input.type = 'date';
          input.className = 'form-control';
          input.id = item.name;
          input.name = item.name;
        } else if (item.type === 'x') {
          input = document.createElement('input');
          input.type = 'checkbox';
          input.className = 'form-check-input';
          input.id = item.name;
          input.name = item.name;
          const label = document.createElement('label');
          label.className = 'form-check-label';
          label.textContent = item.label;
          label.setAttribute('for', item.name); // Link label to checkbox
          colDiv.appendChild(label);
        } else if (item.type === 'select') {
          input = document.createElement('select');
          input.className = 'form-select';
          input.id = item.name;
          input.name = item.name;
          const option = document.createElement('option');
          option.value = 'option1';
          option.textContent = 'Option 1';
          input.appendChild(option);
        }

        colDiv.appendChild(input);
        currentRow.appendChild(colDiv);
        currentColSum += item.col;
      });
    }
  </script>
</body>
</html>